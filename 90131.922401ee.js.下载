"use strict";(self.webpackChunkapp_botstudio_main=self.webpackChunkapp_botstudio_main||[]).push([["90131"],{669118:function(e,t,r){r.d(t,{m3:()=>H,s2:()=>X,lV:()=>P,LX:()=>L,xm:()=>x,qu:()=>m,yn:()=>E,QQ:()=>q,lt:()=>F,VT:()=>G,kS:()=>V,wo:()=>J,l_:()=>B,AF:()=>U});var n,a,i,l,o,s=r("723530"),u=r("271886"),d=r("533076"),c=r("16242"),y=r("168074"),h=r("345305"),v=r("341333"),_=r("265489"),p=r("888953"),C=r("922321"),f=r("468745"),S=r("32382");var A=((n={}).Null="Null",n.TTSPlaying="TTSPlaying",n.AudioPlayEnd="AudioPlayEnd",n.ChatFailed="ChatFailed",n.OutOfDailyQuota="OutOfDailyQuota",n.StartChatError="StartChatError",n.SocketSendErrorSocketClosed="socket_send_error_SocketClosed",n.SocketSendErrorSocketConnecting="socket_send_error_SocketConnecting",n),E=(0,v._)({},A,S.z6,S.wi,S.tw),T={currentPlayer:{isPlaying:!1,isLoading:!1,currentPlayerId:""},audioChat:{chatEvent:E.ChatEnded,playerPlaying:!1}},g=(0,C.Ue)()((0,p.mW)((0,p.XR)(e=>(0,_._)((0,v._)({},T),{initStore(){e((0,v._)({},T))},setCurrentPlayerByImmer:t=>e((0,f.Uy)(e=>{var{currentPlayer:r}=e;return t(r)})),setAudioChatByImmer:t=>e((0,f.Uy)(e=>{var{audioChat:r}=e;return t(r)}))})))),m=()=>{var{currentPlayerId:e,isPlaying:t,isLoading:r}=g((0,h.N)(e=>({currentPlayerId:e.currentPlayer.currentPlayerId,isPlaying:e.currentPlayer.isPlaying,isLoading:e.currentPlayer.isLoading})));return{currentPlayerId:e,isPlaying:t,isLoading:r}},P=()=>{var{setCurrentPlayerByImmer:e}=g.getState();return{setAudioId:t=>{e(e=>{e.currentPlayerId=t})},setAudioState:t=>{e(e=>{e.isPlaying=t})},setAudioLoading:t=>{e(e=>{e.isLoading=t})}}},R=r("255721"),D=r("707567"),O=r("709521"),k=r("498842"),b=new class e{success(e){var{eventName:t,meta:r}=e;k.E7.successEvent({eventName:t,meta:(0,v._)({success:1},r)})}error(e){var{eventName:t,reason:r,error:n,meta:a}=e;k.E7.errorEvent({eventName:t,error:n||Error(r),meta:(0,v._)({success:0,reason:r},a)})}};var w=((a={}).TTS_VOICE_TOKEN="tts_voice_token",a.TTS_VOICE_WS="tts_voice_ws",a.AUDIO_PLAY_ERROR="audio_play_error",a.LANG_DETECT="lang_detect",a.ANALYSE="analyse",a.VOICE_CHAT_TOKEN="voice_chat_token",a.VOICE_CHAT_START_SESSION="voice_chat_assistant_start_session",a.VOICE_CHAT_START_SESSION_ERROR="voice_chat_assistant_start_session_error",a.VOICE_CHAT_SERVER_ERROR="voice_chat_server_error",a),N=e=>{var{f32Buffer:t,audioContext:r,fftSize:n,onSpectrumData:a}=e;if(!!a&&!(t.length<=0)){var i=r.createBuffer(1,t.length,r.sampleRate);i.copyToChannel(t,0,0);var l=new OfflineAudioContext(1,t.length,r.sampleRate),o=l.createAnalyser();o.fftSize=n;var s=l.createBufferSource();return s.buffer=i,s.connect(o),o.connect(l.destination),s.start(0),l.startRendering().then(e=>{var t=new Uint8Array(o.frequencyBinCount);o.getByteFrequencyData(t),null==a||a(t)}).catch(e=>{b.error({eventName:w.ANALYSE,error:e instanceof Error?e:void 0,reason:"audio_data_analyse_render"})})}};class I{static getInstance(){return!I.instance&&(I.instance=new I),I.instance}updateToken(){var e,t;null===(t=this.ttsPlayer)||void 0===t||null===(e=t.ttsSpeechClient)||void 0===e||e.updateToken(this.token)}getToken(){var e=this;return(0,R._)(function*(){try{var t,r=yield O.nA.GetVoiceToken({});e.token=(null===(t=r.data)||void 0===t?void 0:t.token)||"",e.updateToken(),b.success({eventName:w.TTS_VOICE_TOKEN})}catch(e){throw b.error({eventName:w.TTS_VOICE_TOKEN,error:e instanceof Error?e:void 0,reason:"get_tts_token_fail"}),e}})()}initTTS(){var e,t,r,{setAudioState:n,setAudioId:a,setAudioLoading:i}=P();this.ttsPlayer=new S.dW({namespace:"VoiceGenie",url:"wss://sami.bytedance.com/internal/api/v1/ws",appkey:"XlkhBkgubZ",token:this.token},{sampleRate:24e3}),(null===(e=this.ttsPlayer)||void 0===e?void 0:e.audioworkletPolyfillEnable)&&(this.ttsAvailable=!1),this.endPlayingData=this.ttsPlayer.playerAudioClient.onAudioData(e=>{N({f32Buffer:e,audioContext:this.audioContext,fftSize:1024,onSpectrumData:this.onTtsSpectrumData})},2560),this.endPlaying=null===(t=this.ttsPlayer)||void 0===t?void 0:t.onPlaying(e=>{n(e),this.eventBus.emit("playing",this.currentChannel,e)}),this.endComplete=null===(r=this.ttsPlayer.playerAudioClient)||void 0===r?void 0:r.onComplete(()=>{n(!1),this.eventBus.emit("complete",this.currentChannel,!1)}),this.endServerError=this.ttsPlayer.ttsSpeechClient.onServerError(e=>{var t;this.eventBus.emit("error",this.currentChannel,e),null===(t=this.ttsPlayer)||void 0===t||t.pause(),n(!1),a(""),i(!1),b.error({eventName:w.TTS_VOICE_WS,error:e instanceof Error?e:void 0,reason:"tts_player_server_error",meta:{detail:JSON.stringify(e)}})})}startTTS(e){var t=this;return(0,R._)(function*(){var r,{speaker:n,disableGetToken:a=!1,pitch:i=0,speechRate:l=1}=e;return yield t.pauseTTS(),!a&&(yield t.getToken()),!t.playRef&&(t.playRef=null===(r=t.ttsPlayer)||void 0===r?void 0:r.start({speaker:n,audio_config:{sample_rate:24e3,format:"pcm",channel:1},extra:{post_process:{pitch:i,speech_rate:l}}})),t.playRef})()}sendTTS(e){var t=this;return(0,R._)(function*(){try{var r=yield t.playRef;null==r||r.sender(e)}catch(e){b.error({eventName:w.TTS_VOICE_WS,reason:"TTS sdk send error",error:e instanceof Error?e:void 0})}})()}endTTS(){var e=this;return(0,R._)(function*(){var t=yield e.playRef;null==t||t.endSend(),e.playRef=null})()}pauseTTS(){var e=this;return(0,R._)(function*(){var t;return e.playRef=null,yield null===(t=e.ttsPlayer)||void 0===t?void 0:t.pause()})()}destroyTTS(){var e;return this.playRef=null,null===(e=this.ttsPlayer)||void 0===e?void 0:e.destroy()}setCurrentChannel(e){this.currentChannel=e}getCurrentChannel(){return this.currentChannel}constructor(){this.currentChannel=null,this.audioContext=new AudioContext({sampleRate:24e3}),this.ttsAvailable=!0,this.endPlayingData=null,this.endPlaying=null,this.endComplete=null,this.endServerError=null,this.onPlayingCb=null,this.eventBus=new D.Z,this.onAnalyseTtsData=e=>(this.onTtsSpectrumData=e,()=>{this.onTtsSpectrumData=null}),this.token="",this.onTtsSpectrumData=null,this.initTTS()}}class B{start(e){var t=this;return(0,R._)(function*(){return t.tts.setCurrentChannel(t.channel),yield t.tts.startTTS(e)})()}send(e){var t=this;return(0,R._)(function*(){yield t.tts.sendTTS(e)})()}end(){var e=this;return(0,R._)(function*(){yield e.tts.endTTS()})()}destroy(){var e=this;return(0,R._)(function*(){yield e.tts.destroyTTS()})()}pause(){var e=this;return(0,R._)(function*(){yield e.tts.pauseTTS()})()}onTtsEvent(){this.tts.eventBus.on("playing",(e,t)=>{this.emit("playing",e,t)}),this.tts.eventBus.on("error",(e,t)=>{this.emit("error",e,t)}),this.tts.eventBus.on("complete",(e,t)=>{this.emit("complete",e,t)})}emit(e,t,r){t===this.channel&&this.eventBus.emit(e,r)}addEventListener(e,t){this.eventBus.on(e,t)}removeEventListener(e,t){this.eventBus.off(e,t)}constructor(e){this.eventBus=new D.Z,this.channel=e,this.tts=I.getInstance(),this.onTtsEvent()}}var L=new class e{playAudioFile(e){var t=this;return(0,R._)(function*(){try{var r;!t.audioPlayer&&(t.audioPlayer=new Audio),t.audioPlayer.src=e,yield null===(r=t.audioPlayer)||void 0===r?void 0:r.play()}catch(e){b.error({eventName:w.AUDIO_PLAY_ERROR,error:e instanceof Error?e:void 0,reason:"audio_play_error"})}})()}pauseAudioFile(){(null===this||void 0===this?void 0:this.audioPlayer)&&this.audioPlayer.pause()}constructor(){this.audioPlayer=new Audio}},x=()=>{var{setAudioId:e,setAudioState:t,setAudioLoading:r}=P(),n=(0,u.Z)(),{audioPlayer:a}=L,i=()=>{null==a||a.pause(),r(!1),t(!1),e("")};(0,s.useEffect)(()=>{var e=()=>{(null==a?void 0:a.paused)?i():t(!0)},r=()=>{i(),y.O$.warning({content:c.o.t("bot_debug_voices_error"),showClose:!1})};return null==a||a.addEventListener("play",e),null==a||a.addEventListener("pause",e),null==a||a.addEventListener("error",r),()=>{null==a||a.removeEventListener("play",e),null==a||a.removeEventListener("pause",e),null==a||a.removeEventListener("error",r)}},[]),(0,s.useEffect)(()=>{"visible"!==n&&!(null==a?void 0:a.paused)&&i()},[n]),(0,d.Z)(()=>{!(null==a?void 0:a.paused)&&i()})},V=e=>{var{setAudioId:t,setAudioState:r,setAudioLoading:n}=P(),a=(0,u.Z)(),i=()=>{var a;null===(a=e.ttsManager)||void 0===a||a.pause(),r(!1),n(!1),t("")};(0,s.useEffect)(()=>{"visible"!==a&&i()},[a]),(0,d.Z)(()=>{i()})};var z=(i=(0,R._)(function*(e){var{data:t}=yield O.pr.LangDetect({detect_text_list:e});return t||[]}),function(e){return i.apply(this,arguments)});var U=(l=(0,R._)(function*(e){var{text:t,defaultStyleId:r,voiceList:n,detectContentLength:a=10,disableContentLength:i=!1}=e,l=r||(null==n?void 0:null===(o=n[0])||void 0===o?void 0:o.style_id);if(n.length<=1)return b.success({eventName:w.LANG_DETECT,meta:{text:t,isdetected:0}}),l;try{var o,s,u,d=t;!i&&a&&(d=t.length>a?t.substring(0,a):t);var c=yield z([d]),y=null==c?void 0:null===(s=c[0])||void 0===s?void 0:s.lang_code,h=(null===(u=n.find(e=>e.language_code===y))||void 0===u?void 0:u.style_id)||l;return b.success({eventName:w.LANG_DETECT,meta:{text:d,isdetected:1,detect_style_id:h}}),h}catch(e){return b.error({eventName:w.LANG_DETECT,error:e instanceof Error?e:void 0,reason:"get_lang_fail"}),l}}),function(e){return l.apply(this,arguments)}),F=e=>{var t,r=(0,s.useRef)(""),n=(0,s.useRef)(""),a=(0,s.useRef)(!1),i=(0,s.useRef)(!1),l=(0,s.useRef)(0),o=(0,s.useRef)([]);var u=(0,s.useCallback)((t=(0,R._)(function*(t){var{content:s,isFinish:u,defaultStyleId:c,voiceList:y,errorCallback:h,detectedCallback:v,detectContentLength:_=10,index:p}=t;if(n.current=o.current.join("")+s,p!==l.current&&u&&(l.current=p||l.current,o.current.push(s)),!a.current&&(n.current.length>=_||n.current.length<_&&u)){var C=n.current;a.current=!0;try{var f=yield U({text:C,defaultStyleId:c,voiceList:y});yield e.ttsManager.start({speaker:f||"",disableGetToken:!0}),i.current=!0,d(n.current),null==v||v(),r.current=n.current}catch(e){null==h||h()}}i.current&&d(n.current)}),function(e){return t.apply(this,arguments)}),[]),d=(0,s.useCallback)(t=>{var n;if(!(t===r.current||(null==t?void 0:t.length)<=(null===(n=r.current)||void 0===n?void 0:n.length))){var a=t.slice(r.current.length);e.ttsManager.send(a),r.current=t}},[]);return{sliceAndSendByLangDetect:u,initSliceState:(0,s.useCallback)(()=>{r.current="",n.current="",a.current=!1,i.current=!1,l.current=0,o.current=[]},[])}};var G=(o=(0,R._)(function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),!0}catch(e){return!1}}),function(){return o.apply(this,arguments)}),H=()=>{var{chatEvent:e,eventDetail:t,playerPlaying:r}=g((0,h.N)(e=>({chatEvent:e.audioChat.chatEvent,eventDetail:e.audioChat.eventDetail,playerPlaying:e.audioChat.playerPlaying})));return{chatEvent:e,eventDetail:t,playerPlaying:r}},J=()=>{var{setAudioChatByImmer:e}=g.getState();return{setChatEvent:(t,r)=>{e(e=>{e.chatEvent=t,e.eventDetail=r})},setPlayerPlaying:t=>{e(e=>{e.playerPlaying=t})}}},Z=new Uint8Array(5120),K=new Float32Array(2560),M=()=>({appkey:"XMfCSfSLwO",url:"wss://audio.coze.cn/internal/api/v1/ws",socketConfig:{customKeepalive:!0,keepAliveInterval:3},auth:"coze_sdk_session",protocol:"v2",token:JSON.stringify({host:location.hostname})}),Q=e=>{var{conversationId:t,uid:r,speaker:n,botId:a,lang:i,draftMode:l,scene:o,pitch:s,speechRate:u}=e;return{enable_audio_input:!0,enable_realtime_roice_call:!0,realtime_voice_call:!0,enable_text_reading:!0,enable_upload_audio:!1,request_type:1,business:4,interrupt_type:1,reconnect_status:0,trigger_type:0,asr:{audio_info:{format:"pcm",sample_rate:16e3,channel:1}},tts:{speaker:n||"zh_female_xiaohe_conversation_wvae_bigtts",audio_config:{sample_rate:24e3,format:"pcm"},extra:{post_process:{pitch:s,speech_rate:u}}},chat:{conversation_id:t,call_id:"",uid:r,interrupt_type:1},coze_chat:{conversation_id:t,bot_id:a,connector_id:"10000010",bot_version:"",biz_user_id:r,lang:i||"zh",extra:{coze_chat_scene:String(o)},draft_mode:l},extra:{}}},W=e=>{if(e)try{var t=JSON.parse(e),r=Object.prototype.hasOwnProperty.call(t,"err_code")&&0!==t.err_code,n=0x29db35c4===t.err_code||0x2f03f322===t.err_code?A.OutOfDailyQuota:A.ChatFailed;return{isError:r,eventName:r?n:void 0}}catch(e){}return{isError:!1}},q=new class e{constructor(){var e,t,r=this;this.initClient=()=>{this.playerAudioClient=new S.JG({sampleRate:24e3}),this.recorderAudioClient=new S.MK({sampleRate:16e3});var e=M(),{setChatEvent:t}=J();this.audioChatClient=new S.Re((0,_._)((0,v._)({},e),{log:e=>{var r,n;(null==e?void 0:null===(r=e.data)||void 0===r?void 0:r.event)&&t(null==e?void 0:null===(n=e.data)||void 0===n?void 0:n.event,JSON.stringify(null==e?void 0:e.data))}}))},this.startAudioChat=(e=(0,R._)(function*(e){try{var t,n=Q(e);yield r.audioChatClient.startSession(n),yield r.playerAudioClientStart(),yield r.recorderAudioClientStart();var a=[],{setChatEvent:i}=J();r.endAsrServerEvent=r.audioChatClient.onServerEvent((t=(0,R._)(function*(e){var t,{eventName:n,isError:l}=W(e.data.payload);e.data.payload&&l&&(i(n),b.error({eventName:w.VOICE_CHAT_SERVER_ERROR,error:Error(JSON.stringify(e.data.payload)),reason:"voice_chat_server_error"}));var o=e.data;return o.event===E.ASREnded&&(yield r.playerAudioClient.init(),yield r.playerAudioClient.start()),o.event===E.TTSEnded&&r.playerAudioClient.finishBuffer(),o.event===E.TTSResponse&&((0,o.data)?r.playerAudioClient.pushBuffer(o.data):yield r.cachePlayerDataProcess(a,null===(t=o.data)||void 0===t?void 0:t.buffer)),o}),function(e){return t.apply(this,arguments)})),b.success({eventName:w.VOICE_CHAT_START_SESSION})}catch(e){b.error({eventName:w.VOICE_CHAT_START_SESSION_ERROR,error:e instanceof Error?e:void 0,reason:"voice_chat_start_session_error"}),J().setChatEvent(E.StartChatError,JSON.stringify(e)),r.endAudioChat()}}),function(t){return e.apply(this,arguments)}),this.playerAudioClientStart=(0,R._)(function*(){yield r.playerAudioClient.clear(),yield r.playerAudioClient.init(),yield r.playerAudioClient.start({clear:!1}),r.endPlayingState=r.playerAudioClient.onPlaying(e=>{J().setPlayerPlaying(e)}),r.endPlayComplete=r.playerAudioClient.onComplete((0,R._)(function*(){yield r.recorderAudioClient.init(),yield r.recorderAudioClient.start(),J().setChatEvent(E.AudioPlayEnd)})),r.endPlayingData=r.playerAudioClient.onAudioData(e=>{N({f32Buffer:e,audioContext:r.audioContext,fftSize:1024,onSpectrumData:r.onTtsSpectrumData})},2560)}),this.recorderAudioClientStart=(0,R._)(function*(){var e=r.audioChatClient.getAudioSender(),t=0;r.recorderAudioClient.onBuffer(n=>{var a=new Uint8Array(n.buffer.buffer);e.send(r.enableAsrSend?a:Z,t++),N({f32Buffer:r.enableAsrSend?n.f32Buffer:K,audioContext:r.audioContext,fftSize:1024,onSpectrumData:r.onAsrSpectrumData})}),yield r.recorderAudioClientPreStart()}),this.recorderAudioClientPreStart=(0,R._)(function*(){yield r.recorderAudioClient.init(),yield r.recorderAudioClient.start()}),this.cachePlayerDataProcess=(t=(0,R._)(function*(e,t){if(t&&e.push(t),e.reduce((e,t)=>e+=t.byteLength,0)>1e3){var n=e.length>1?function(e){var t=new ArrayBuffer(e.reduce((e,t)=>e+t.byteLength,0)),r=new Uint8Array(t),n=0;for(var a of e)r.set(new Uint8Array(a.slice(0)),n),n+=a.byteLength;return t}(e):e[0];e.length=0;var a=yield r.audioContext.decodeAudioData(n);r.playerAudioClient.pushBuffer(a.getChannelData(0))}}),function(e,r){return t.apply(this,arguments)}),this.interrupt=(0,R._)(function*(){r.audioChatClient.interrupt(),yield r.playerAudioClient.destroy(),yield r.recorderAudioClient.start()}),this.finishSession=()=>{this.audioChatClient.finishSession()},this.recorderAudioClientEnd=(0,R._)(function*(){yield r.recorderAudioClient.pause(),yield r.recorderAudioClient.clear(),yield r.recorderAudioClient.destroy(),r.endAsrServerEvent&&r.endAsrServerEvent(),r.endAsrServerEvent=null}),this.playerAudioClientEnd=(0,R._)(function*(){r.playerAudioClient.finishBuffer(),yield r.playerAudioClient.pause(),yield r.playerAudioClient.clear(),yield r.playerAudioClient.destroy(),r.endPlayingState&&r.endPlayingState(),r.endPlayingState=null,r.endPlayingData&&r.endPlayingData(),r.endPlayingData=null,r.endPlayComplete&&r.endPlayComplete(),r.endPlayComplete=null}),this.endAudioChat=(0,R._)(function*(){yield r.recorderAudioClientEnd(),yield r.playerAudioClientEnd(),yield r.audioChatClient.tryFinishSession()}),this.destroyAudioChat=(0,R._)(function*(){yield r.endAudioChat(),yield r.recorderAudioClient.destroy(),yield r.audioChatClient.destroy(),yield r.playerAudioClient.destroy()}),this.stopAsrSend=()=>{this.enableAsrSend=!1;var e=setTimeout(()=>{this.enableAsrSend=!0,clearTimeout(e)},1800)},this.onAnalyseAsrData=e=>(this.onAsrSpectrumData=e,()=>{this.onAsrSpectrumData=null}),this.onAnalyseTtsData=e=>(this.onTtsSpectrumData=e,()=>{this.onTtsSpectrumData=null}),this.endAsrServerEvent=null,this.endPlayingState=null,this.endPlayingData=null,this.endPlayComplete=null,this.audioContext=new AudioContext({sampleRate:24e3}),this.enableAsrSend=!0,this.onAsrSpectrumData=null,this.onTtsSpectrumData=null,this.initClient()}},X=new B("text-chat")}}]);
//# sourceMappingURL=https://sourcemap-redirect.coze.cn/obj/coze-sourcemap/ol-sourcemap/bot/1.0.2.2592/90131.922401ee.js.map